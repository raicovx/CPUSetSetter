name: Build and Release

permissions:
  contents: write

on:
  # push:
  #   tags:
  #     - "v*"

  workflow_dispatch:
    inputs:
      release_tag:
        description: Git tag to release (e.g., v1.2.3)
        required: true
      release_description:
        description: Release notes/description
        required: true

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Set version variable
        run: |
          if ($env:GITHUB_EVENT_NAME -eq "workflow_dispatch") {
              $tag = '${{ github.event.inputs.release_tag }}'
              $desc = '${{ github.event.inputs.release_description }}'
          } else {
              $tag = $env:GITHUB_REF_NAME
              $desc = "Release $tag"
          }
          $version = $tag.TrimStart('v')
          # Ensure version is quad format for MSIX (e.g. 1.2.3.0)
          if ($version.Split('.').Count -eq 3) { $msixVersion = "$version.0" }
          
          echo "VERSION=$version" >> $env:GITHUB_ENV
          echo "MSIXVERSION=$msixVersion" >> $env:GITHUB_ENV
          echo "RELEASE_TAG=$tag" >> $env:GITHUB_ENV
          echo "RELEASE_DESC=$desc" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Publish normal
        run: dotnet publish CPUSetSetter/CPUSetSetter.csproj -c Release /p:DebugType=None /p:DebugSymbols=false /p:FileVersion=${{ env.VERSION }} /p:Version=${{ env.VERSION }} /p:SelfContained=false -o publish/CPUSetSetter

      - name: Publish self-contained
        run: dotnet publish CPUSetSetter/CPUSetSetter.csproj -c Release /p:DebugType=None /p:DebugSymbols=false /p:FileVersion=${{ env.VERSION }} /p:Version=${{ env.VERSION }} /p:PublishSingleFile=true /p:SelfContained=true -o publish/CPUSetSetter_net9_included

      - name: Include licenses
        run: |
          dotnet tool install --global nuget-license
          nuget-license -i .\CPUSetSetter\CPUSetSetter.csproj -t -d .\third-party-licenses
          Copy-Item -Path .\third-party-licenses -Destination .\publish\CPUSetSetter -Recurse
          Copy-Item -Path .\third-party-licenses -Destination .\publish\CPUSetSetter_net9_included -Recurse
          Copy-Item -Path .\LICENSE -Destination .\publish\CPUSetSetter\LICENSE.txt
          Copy-Item -Path .\LICENSE -Destination .\publish\CPUSetSetter_net9_included\LICENSE.txt

      - name: Build installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /O".\release_files" /DMyAppVersion=${{ env.VERSION }} .\Installer_script\Installer.iss

      - name: Generate AppxManifest.xml
        run: |
          $manifestContent = @"
          <?xml version="1.0" encoding="utf-8"?>
          <Package xmlns="http://schemas.microsoft.com/appx/manifest/foundation/windows10" 
                   xmlns:uap="http://schemas.microsoft.com/appx/manifest/uap/windows10" 
                   xmlns:rescap="http://schemas.microsoft.com/appx/manifest/foundation/windows10/restrictedcapabilities">
            <Identity Name="CPUSetSetter" 
                      Publisher="CN=CPUSetSetterSelfSign" 
                      Version="${{ env.MSIXVERSION }}" 
                      ProcessorArchitecture="x64" />
            <Properties>
              <DisplayName>CPUSetSetter</DisplayName>
              <PublisherDisplayName>CPUSetSetter</PublisherDisplayName>
              <Logo>Images\StoreLogo.png</Logo>
            </Properties>
            <Dependencies>
              <TargetDeviceFamily Name="Windows.Desktop" MinVersion="10.0.17763.0" MaxVersionTested="10.0.22000.0" />
            </Dependencies>
            <Resources>
              <Resource Language="x-generate"/>
            </Resources>
            <Applications>
              <Application Id="App" Executable="CPUSetSetter.exe" EntryPoint="Windows.FullTrustApplication">
                <uap:VisualElements DisplayName="CPUSetSetter" 
                                    Description="CPU Set Setter Utility" 
                                    BackgroundColor="transparent" 
                                    Square150x150Logo="Images\Square150x150Logo.png" 
                                    Square44x44Logo="Images\Square44x44Logo.png">
                </uap:VisualElements>
              </Application>
            </Applications>
            <Capabilities>
              <rescap:Capability Name="runFullTrust" />
            </Capabilities>
          </Package>
          "@
          
          $manifestContent | Out-File -FilePath ".\publish\CPUSetSetter\AppxManifest.xml" -Encoding UTF8
          
          # Create dummy images so MakeAppx doesn't fail (You should add real ones to your repo later)
          New-Item -ItemType Directory -Force -Path ".\publish\CPUSetSetter\Images"
          New-Item -Path ".\publish\CPUSetSetter\Images\StoreLogo.png" -ItemType File -Value " "
          New-Item -Path ".\publish\CPUSetSetter\Images\Square150x150Logo.png" -ItemType File -Value " "
          New-Item -Path ".\publish\CPUSetSetter\Images\Square44x44Logo.png" -ItemType File -Value " "
        shell: pwsh

      - name: Package MSIX
        run: |
          # Find MakeAppx in the Windows SDK
          $sdkDir = "C:\Program Files (x86)\Windows Kits\10\bin"
          $sdkVer = Get-ChildItem $sdkDir | Where-Object { $_.Name -match "^10\." } | Sort-Object Name -Descending | Select-Object -First 1
          $makeAppx = "$sdkDir\$($sdkVer.Name)\x64\makeappx.exe"
          
          # Package the publish folder
          & $makeAppx pack /d ".\publish\CPUSetSetter" /p ".\release_files\CPUSetSetter.msix" /o
        shell: pwsh

      - name: Sign MSIX (Self-Signed)
        run: |
          # 1. Create a self-signed certificate
          $cert = New-SelfSignedCertificate -Type Custom -Subject "CN=CPUSetSetterSelfSign" -KeyUsage DigitalSignature -FriendlyName "CPUSetSetter" -CertStoreLocation "Cert:\CurrentUser\My" -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}")
          
          # 2. Export certificate to file (needed for SignTool)
          $password = ConvertTo-SecureString -String "Password123" -Force -AsPlainText
          Export-PfxCertificate -Cert $cert -FilePath ".\cert.pfx" -Password $password
          
          # 3. Find SignTool
          $sdkDir = "C:\Program Files (x86)\Windows Kits\10\bin"
          $sdkVer = Get-ChildItem $sdkDir | Where-Object { $_.Name -match "^10\." } | Sort-Object Name -Descending | Select-Object -First 1
          $signTool = "$sdkDir\$($sdkVer.Name)\x64\signtool.exe"
          
          # 4. Sign the package
          & $signTool sign /fd SHA256 /a /f ".\cert.pfx" /p "Password123" ".\release_files\CPUSetSetter.msix"
        shell: pwsh

      - name: Compress Release files
        run: |
          Compress-Archive -Path .\publish\CPUSetSetter -DestinationPath .\release_files\CPUSetSetter.zip
          Compress-Archive -Path .\publish\CPUSetSetter_net9_included -DestinationPath .\release_files\CPUSetSetter_net9_included.zip

      - name: Show Release file hashes
        run: Get-FileHash .\release_files\* | Format-List Algorithm, Path, Hash

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          body: ${{ env.RELEASE_DESC }}
          files: release_files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
